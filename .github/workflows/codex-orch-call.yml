name: codex-orch-call

on:
  schedule:
    - cron: "*/15 23,0-12 * * *" # UTC (JST 08:00-21:59)
  workflow_dispatch:
    inputs:
      dry_run:
        description: "1: 取得とプロンプト生成のみ / 0: 実処理"
        required: false
        default: "1"
        type: choice
        options:
          - "1"
          - "0"
      codex_model:
        description: "codex exec に指定するモデル"
        required: false
        default: "gpt-5-codex"
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run:
    if: ${{ github.event_name != 'schedule' || vars.ORCH_ENABLE_SCHEDULE == '1' }}
    runs-on: ubuntu-latest
    concurrency:
      group: codex-orch-${{ github.repository }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout caller repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout orchestrator repository
        uses: actions/checkout@v4
        with:
          repository: mashirou1234/Neunzehn
          ref: v1.14
          path: .orch
          token: ${{ secrets.ORCH_REPO_READ_TOKEN != '' && secrets.ORCH_REPO_READ_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Codex CLI
        if: ${{ '1' != '1' }}
        run: npm i -g @openai/codex@latest

      - name: Run orchestrator
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORCH_SCM: github
          ORCH_TZ: Asia/Tokyo
          ORCH_WINDOW_START: "08:00"
          ORCH_WINDOW_END: "22:00"
          ORCH_ISSUE_LABEL_QUEUE: codex:queue
          ORCH_ISSUE_LABEL_CLAIMED: codex:claimed
          ORCH_ISSUE_LABEL_BLOCKED: codex:blocked
          ORCH_ISSUE_LABEL_PR: codex:pr-opened
          ORCH_BRANCH_PREFIX: codex/issue-
          ORCH_MAX_TASKS_PER_RUN: "1"
          ORCH_DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || '1' }}
          ORCH_NO_COST_MODE: "1"
          ORCH_SAVE_JSON_EVENTS: "1"
          ORCH_CODEX_MODEL: ${{ github.event_name == 'workflow_dispatch' && inputs.codex_model || 'gpt-5-codex' }}
          ORCH_SETUP_CMDS: ""
          ORCH_TEST_CMDS: ""
        run: bash ./.orch/scripts/orch.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex-orch-artifacts
          path: artifacts/
          if-no-files-found: ignore
